rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the authenticated user has an 'admin' role
    function isAdmin() {
      return get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }

    // Profiles collection:
    // - Authenticated users can read their own profile.
    // - Authenticated users can create their own profile (e.g., on first login/signup).
    // - Authenticated users can update their own profile.
    // - Admins can read and update all profiles.
    // - Only admins can delete profiles.
    match /profiles/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if isAdmin();
    }

    // Curriculum content collections (phases, modules, lessons, quizzes, quiz_questions):
    // - Public read access for everyone.
    // - Only admins can create, update, or delete these documents.
    match /phases/{phaseId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /modules/{moduleId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /lessons/{lessonId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /quizzes/{quizId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /quiz_questions/{questionId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Student progress collection:
    // - Authenticated users can read, create, and update their own progress.
    // - Admins can delete any progress entry.
    match /student_progress/{progressId} {
      allow read, create, update: if request.auth != null && request.auth.uid == request.resource.data.user_id;
      allow delete: if isAdmin();
    }

    // Quiz attempts collection:
    // - Authenticated users can read, create, and update their own quiz attempts.
    // - Admins can delete any quiz attempt.
    match /quiz_attempts/{attemptId} {
      allow read, create, update: if request.auth != null && request.auth.uid == request.resource.data.user_id;
      allow delete: if isAdmin();
    }
  }
}